pipeline {
    agent any 

    environment {
        TOOL_DIR = "${WORKSPACE}\\ci-cd-tools"
    }

    stages {
        stage('Build') { 
            steps {
				sh 'echo Comenzando Build'
				sh 'arm-none-eabi-gcc --version'
				sh 'make -C src/ci-cd-tools/ clean'
				catchError(buildResult: 'FAILED', stageResult: 'FAILED') {
					sh 'make -C src/ci-cd-tools/ -j8 all 2> src/ci-cd-tools/compilation_error.log'
				}
				script {
					if ( $BUILD_STATUS == 'FAILED' ) {
						sh 'cat src/ci-cd-tools/compilation_error.log | exit 1'
					}
				}
				catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
					sh 'cat src/ci-cd-tools/compilation_error.log'
                    sh 'bash src/ci-cd-tools/warning_script.sh'
                }
            }
        }
        stage('Static Analysis') { 
            steps {
				/* Analisis estaticos, bajo un catch error para que den como resultado builds inestables pero no detengan todo el proceso */
				catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
                    sh 'cppcheck --error-exitcode=2 --inline-suppr --suppress=*:*test/* --enable=style --force src/'
                }
            }
        }
    }

    post {
		always {
			sh 'echo Pipeline Finalizada.'
			/* Log de issues de Warning Plugin */
			recordIssues(
				enabledForFailure: true, aggregatingResults: true,
				tools: [gcc()]
			)
			/*
			findText(textFinders: [
				textFinder(regexp: 'warning', alsoCheckConsoleOutput: true, buildResult: 'UNSTABLE')
			])
			*/
		}
        success {
			sh 'echo success'
        }
        unsuccessful {
            script {
                emailext (
                    to: '${DEFAULT_RECIPIENTS}',
                    subject: "Unsuccessful build ${env.BUILD_ID}",
                    body: "Build ${env.BUILD_ID} has result ${currentBuild.currentResult}"
                )
            }
        }
    }
}